{% extends "layouts/base.html" %}

{% block title %} Game Plan {% endblock title %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

{% include "beachhandball/templates/_modal.html" %}

<h2>Game Plan</h2>
<hr>
<div class="row">
  <div class="col-lg-8 col-md-8 col-sm-8">
    <div>
      {% if games|length == 0 %}
        <h3>No Games defined. Please add or run wizard</h3>
        <a class="btn btn-primary w-100" href="{{ url('setup_wizard_gameplan') }}">GamePlan Wizard</a>
      {% endif %}
    </div>
    <div class="card card-stats">
      <div class="card-header">
        <a class="btn btn-primary" data-toggle="collapse" href="#panel-filter" role="button" aria-expanded="false" aria-controls="collapseExample">
          Filter
          <i class="material-icons">keyboard_arrow_down</i>
        </a>
      </div>
      <div id="panel-filter" class="collapse">
        <div class="card-body">
          <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header">
                  <div class="col d-flex justify-content-left">
                    <h4 class="card-title">by Event:</h4>
                  </div>
                </div>
                <div class="card-body">
                  <div class="col d-flex justify-content-center">
                    <select id="filter-tevent" class="selectpicker" onchange="add_filter_tevent();" data-size="7" data-style="btn btn-primary btn-round" title="Select Event">
                      <option value="-1">All</option>
                      {% for event in events %}
                      <option value="{{ event.id }}">{{ event.name }} ({{ event.category}})</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header">
                  <div class="col d-flex justify-content-left">
                    <h4 class="card-title">by State:</h4>
                  </div>
                </div>
                <div class="card-body">
                  <div class="col d-flex justify-content-center">
                    <select id="filter-tstate" class="selectpicker" onchange="add_filter_tstate();" data-size="7" data-style="btn btn-primary btn-round" title="Select State">
                          <option value="-1">All</option>
                          {% for tstate in tstates %}
                          <option value="{{ tstate.id }}">{{ tstate.name }} ({{ tstate.tournament_event.category }})</option>
                          {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header">
                  <div class="col d-flex justify-content-left">
                    <h4 class="card-title">by Court:</h4>
                  </div>
                </div>
                <div class="card-body">
                  <div class="col d-flex justify-content-center">
                    <select id="filter-court" class="selectpicker" onchange="add_filter_court();" data-size="7" data-style="btn btn-primary btn-round" title="Select Court">
                          <option value="-1">All</option>
                          {% for court in courts %}
                          <option value="{{ court.id }}">{{ court.name }}</option>
                          {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>


            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header">
                  <div class="col d-flex justify-content-left">
                    <h4 class="card-title">by Gamestate:</h4>
                  </div>
                </div>
                <div class="card-body">
                  <div class="col d-flex justify-content-center">
                    <select id="filter-gamestate" class="selectpicker" onchange="add_filter_gamestate();" data-size="7" data-style="btn btn-primary btn-round" title="Select GameState">
                          <option value="-1">All</option>
                          <option value="FINISHED">FINISHED</option>
                          <option value="RUNNING">RUNNING</option>
                          <option value="APPENDING">APPENDING</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-3 col-md-6 col-sm-6">
              <div class="card card-stats">
                <div class="card-header">
                  <div class="col d-flex justify-content-left">
                    <h4 class="card-title">by keyword:</h4>
                  </div>
                </div>
                <div class="card-body">
                  <div class="col d-flex justify-content-center">
                    <input type="text" placeholder="Filter by keyword" id="filter-keyword" onkeyup="add_filter_keyword();" class="form-control">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div calss="col">
            <input type="text" placeholder="Search Table" id="games-filter" class="form-control" hidden>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4 col-md-4 col-sm-4">
    <div class="card card-stats">
      <div class="card-header">
        <a class="btn btn-primary" data-toggle="collapse" href="#panel-editing" role="button" aria-expanded="false" aria-controls="collapseExample">
          Editing
          <i class="material-icons">keyboard_arrow_down</i>
        </a>
      </div>
      <div id="panel-editing" class="collapse">
        <div class="card-body">
          <div class="form-check">
            <input type="checkbox" class="" id="checkBoxEnableDragging" onclick="enable_dragging()">
            <label class="form-check-label" for="updown-checkbox">Enable Game Dragging</label>
          </div>

          <div class="row">
            <button id="export-button" class="btn btn-primary export-button">Export CSV</button>
          </div>
        
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12 col-md-12 col-sm-12">
    <div class="card card-stats">
      <div class="card-body">
        <div class="table-responsive">
              <table id="table-games" class="table">
                <thead class=" text-primary">
                  <th hidden data-col="tournament_event">tournament_event</th>
                  <th class="text-left" data-col="date">Date</th>
                  <th class="text-left" data-col="id">ID</th>
                  <th class="text-left" data-col="category"></th>
                  <th class="text-left" data-col="tournament_state">State</th>
                  <th class="text-left" data-col="team_a">Team A</th>
                  <th class="text-left" data-col="team_b">Team B</th>
                  <th class="text-left" data-col="court">Court</th>
                  <th class="text-left" data-col="result_ht1">1. HT</th>
                  <th class="text-left" data-col="result_ht2">2. HT</th>
                  <th class="text-left" data-col="result_p">Shootout</th>
                  <th class="text-left" data-col="sets">Sets</th>
                  <th class="text-left" data-col="gamestate">Gamestate</th>
                  <th data-col="actions">Actions</th>
                </thead>
                <tbody>
                  {% for game in games %}
                  <tr class="game-row">
                    <td hidden data-content="{{ game.tournament_event.id }}">{{ game.tournament_event.id }}</td>
                    <td id="game-list-td-id-{{ game.id }}" data-content="datetime" class="game-list-datetime-td">
                    <div id="id_starttime_label" class="game-list-datetime-label">{{ game.starttime.strftime('%H:%M (%d.%m.%Y)') }}</div>
                    <div class="game-list-datetime-input" hidden>
                      <input id="id_starttime" data-game_id="{{ game.id }}" class="game-list-datetime form-control datetimepicker" type="text" name="starttime" value="{{ game.starttime }}">
                      <input id="initial-id_starttime" type="hidden" class="game-list-datetime-init" name="initial-starttime" value="{{ game.starttime }}">
                    </div>
                    </td>
                    <td id="game_id_counter" class="text-center" data-content="{{ game.id }}">{{ game.id_counter }}</td>
                    <td data-content="{{ game.tournament_event.category }}">{{ game.tournament_event.category }}</td>
                    <td class="text-center" data-content="{{ game.tournament_state.id }}">
                    <div class="btn btn-small" style="background: {{ game.tournament_state.color }}">
                      <a href="{{ url('structure_setup.detail', kwargs={'pk': game.tournament_event.id }) }}" style="color:white;"><b>{{ game.tournament_event.category.abbreviation }} {{ game.tournament_state.abbreviation }}</b>
                    </div>
                    
                    </td>
                    <td class="text-center" data-content="{{ game.team_st_a.team }}">{% if game.team_st_a.id == game.winner %}<button class="btn btn-outline-info"><i class="material-icons">emoji_events</i><b>{{ game.team_st_a.team }}</b></button>{% else %}{{ game.team_st_a.team }}{% endif %}</td>
                    <td class="text-center" data-content="{{ game.team_st_b.team }}">{% if game.team_st_b.id == game.winner %}<button class="btn btn-outline-info"><i class="material-icons">emoji_events</i><b>{{ game.team_st_b.team }}</b></button></b>{% else %}{{ game.team_st_b.team }}{% endif %}</td>
                    <td id="game-list-td-court-{{ game.id }}" class="game-list-court-td text-center" data-content="{{ game.court.id }}">
                      <div class="game-list-court-label">{{ game.court.name }}</div>
                      <div class="game-list-court-select" data-game_id="{{ game.id }}" hidden>
                        <select class="selectpicker" title="Select Court..." data-game_id="{{ game.id }}">
                          {% for court in courts %}
                            <option value="{{ court.id }}">#{{court.number}} {{court.name}}</option>
                          {% endfor%}
                        </select>
                      </div>
                    </td>
                    <td id="{{ game.id }}_result_ht1" class="text-center" data-content="result_ht1">{{ game.score_team_a_halftime_1 }}:{{ game.score_team_b_halftime_1 }}</td>
                    <td id="{{ game.id }}_result_ht2" class="text-center" data-content="result_ht2">{{ game.score_team_a_halftime_2 }}:{{ game.score_team_b_halftime_2 }}</td>
                    <td id="{{ game.id }}_result_p" class="text-center" data-content="result_p">{{ game.score_team_a_penalty }}:{{ game.score_team_b_penalty }}</td>
                    <td class="text-center" data-content="sets">{{ game.setpoints_team_a }}:{{ game.setpoints_team_b }}</td>
                    <td class="text-center" data-content="{{ game.gamestate }}">{{ game.gamestate }}</td>
                    <td class="td-actions text-right" data-content="">
                      <button type="button" class="update_game btn btn-success btn-link" rel="tooltip" title="Edit Game" data-form-url='{{ url("update_game", kwargs={"pk_tevent":game.tournament_event.id, "pk_tstage": game.tournament_state.tournament_stage.id, "pk":  game.id, "from_gameplan": 1}) }}' data-list-url="{{ url('game_plan') }}" onclick="modalShowSpinner();">
                          <i class="material-icons">edit</i>
                      </button>
                      <button type="button" rel="tooltip" class="download-pregame-report btn btn-info btn-link" rel="tooltip" title="Download Pre-Game Report" data-form-url="{{ url('download_pre_game', kwargs={'pk_tevent':game.tournament_event.id, 'pk_tstage': game.tournament_state.tournament_stage.id, 'pk':  game.id}) }}" data-list-url="{{ url('game_plan') }}">
                          <a class="" href="{{ url('download_pre_game', kwargs={'pk_tevent':game.tournament_event.id, 'pk_tstage': 1, 'pk':  game.id}) }}">
                              <i class="material-icons">file_download</i>
                          </a>
                      </button>
                      <button type="button" rel="tooltip" class="update-game-result btn btn-info btn-link" rel="tooltip" title="Enter Result" data-form-url='{{ url("update_game_result", kwargs={"pk_tevent":game.tournament_event.id, "pk_tstage": game.tournament_state.tournament_stage.id, "pk":  game.id, "from_gameplan": 1}) }}' data-list-url="{{ url('game_plan') }}" onclick="modalShowSpinner();" >
                          <i class="material-icons">assignment</i>
                      </button>
                      <!--button type="button" rel="tooltip" class="delete-game btn btn-danger btn-link" rel="tooltip" title="Delete Game"  data-form-url='{{ url("structure_setup.delete_game", kwargs={"pk_tevent":game.tournament_event.id, "pk_tstage": game.tournament_state.tournament_stage.id, "pk":  game.id}) }}' onclick="modalShowSpinner();" >
                          <i class="material-icons">close</i>
                      </button-->
                  </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
      
      </div>
      <div class="card-footer">
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}

<script>
  let draggedRow = null;

    $(document).ready(function() {
      //md.initFullCalendar();
      //md.initFullCalendar2();
      $("#update-game-result-form").modal("hide");
      $("#update-game-result-form").LoadingOverlay("hide");

      {% if messages %}
        console.log("Has messages...");
        {% for message in messages %}
        md.showNotification('top','center', '{{ message }}', 'info');
        {% endfor %}
      {% endif %}

      var exportButtons = document.querySelectorAll(".export-button");

      exportButtons.forEach(function(button) {
        button.addEventListener("click", function() {
          // Get the table element

          var table = document.getElementById("table-games");

          // Initialize the output string with column headers
          var output = "Game Plan\n\n";
          //output += "#\tName\tPosition\tID\n";

          // Iterate over table rows and columns to build the output string
          for (var i = 0; i < table.rows.length; i++) {
            var row = table.rows[i];
            
            // Check if the row is hidden
            if (row.style.display !== "none") {
              for (var j = 0; j < row.cells.length; j++) {
                output += row.cells[j].innerText + "\t";
              }
              output += "\n";
            }
          }

          // Create a Blob with the text content
          var blob = new Blob([output], { type: "text/plain" });

          // Create a temporary link element to initiate the download
          var link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "game_plan_export.txt";

          // Simulate a click on the link to trigger the download
          link.click();
        });
      });
        
      md.initFormExtendedDatetimepickers();
      $.fn.dataTable.moment( 'HH:mm (DD.MM.YYYY)' );

      var table = $('#table-games').DataTable({
        searching: false,
        paging: false,
        "order": [[1, 'asc']]
      });

      // Repair DateTime Form because datetimepicker.min.js deletes input value on load
      $(".game-list-datetime" ).each(function(i, datetime_input){
        var userDate = datetime_input.attributes.value.value;
        var date_string = moment(userDate, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY HH:mm");
        $(datetime_input).val(date_string);
      });


      //$('table').tableFilter({});
      $('#table-games').filterTable('#games-filter');
      //$('table').tableFilter('filterRows', 'The Beachers');

      var actTime = '';
      var colors = ['#f2f2f2', '#d9d9d9'];
      var actColor = 'red';
      var isFirst = true;
      var colorIdx = 0;
      $('#table-games').find('tr').each(function(index) {

        $row = $(this);
        $(this).on('dragstart', dragStart);
        $(this).on('dragover', dragOver);
        $(this).on('dragenter', dragEnter);
        $(this).on('dragleave', dragLeave);
        $(this).on('drop', drop);
        $(this).on('dragend', dragEnd);

        //console.log($row.find('#id_starttime').val());
        $starttime = $row.find('#id_starttime');
        if ($starttime.length == 0) {
          return;
        }
        if(isFirst)
        {
          isFirst = false;
          actTime = $starttime.val();
          $row.css('background-color', colors[colorIdx]);
        }

        if($starttime.val() == actTime)
        {}
        else
        {
          actTime = $starttime.val();
          colorIdx++;
          if(colorIdx == 2)
          {colorIdx = 0;}
        }

        $row.css('background-color', colors[colorIdx]);
      });

    });

    function enable_dragging() {
      if (document.getElementById('checkBoxEnableDragging').checked) {
        $('#table-games').find('tr').each(function(index) {
          $(this).attr('draggable', 'true');
        });
    } else {
      $('#table-games').find('tr').each(function(index) {
        $(this).attr('draggable', 'false');
      });
    }
    }

    // Handle the start of a drag event
    function dragStart(e) {
      console.log("drag start");
      draggedRow = e.target;
      console.log("Dragged row ID:", $(draggedRow).find('#game_id_counter')[0].innerText);
      //draggedRow.classList.add('tr-dragged');
      //e.dataTransfer.setData('text/plain', ''); // Needed for Firefox
    }

    // Handle the dragging over of a row
    function dragOver(e) {
      const row = e.target.closest('.game-row');
      //console.log("Dragged OVER row ID:", $(row).find('#game_id_counter')[0].innerText);
      e.preventDefault();
      this.classList.add('tr-over');
    }

    // Handle the entering of a row during drag
    function dragEnter(e) {
      const row = e.target.closest('.game-row');
      //console.log("drag enter ", $(row).find('#game_id_counter')[0].innerText, ' ' + $(draggedRow).find('#game_id_counter')[0].innerText);
      e.preventDefault();
      this.classList.add('tr-over');
      //$(row).css('border', '5px solid black');
    }

    // Handle the leaving of a row during drag
    function dragLeave(e) {
      const row = e.target.closest('.game-row');
      //console.log("drag leave ", $(row).find('#game_id_counter')[0].innerText, ' ' + $(draggedRow).find('#game_id_counter')[0].innerText);
      this.classList.remove('tr-over');
      //$(row).css('border', '0px solid black');
    }

    // Handle the drop of a row
    function drop(e) {
      console.log("drag drop");
      const row = e.target.closest('.game-row');
      const droppedRow = e.target;
      console.log("Dragged DROP before row ID:", $(row).find('#game_id_counter')[0].innerText);
      e.preventDefault();


      let targetRow = $(this);
      if (targetRow.hasClass('tr-over') && draggedRow !== targetRow[0]) {
        
        var date_string_dragged = moment($(draggedRow).find('#id_starttime')[0].value, "MM/DD/YYYY HH:mm").format("YYYY-MM-DD HH:mm:ss");
        var date_string_target = moment(targetRow.find('#id_starttime')[0].value, "MM/DD/YYYY HH:mm").format("YYYY-MM-DD HH:mm:ss");
        //console.log("datestring dragged ", date_string_dragged);
        var dateValueDragged = $(draggedRow).find('#id_starttime')[0].value;
        var dateValueTarget = targetRow.find('#id_starttime')[0].value;

        var game_id_dragged = $(draggedRow).find('#id_starttime').eq(0).data('game_id');
        var game_counter_dragged = $(draggedRow).find('#game_id_counter')[0].innerText;
        var date_label_dragged = moment(date_string_dragged, "YYYY-MM-DD HH:mm:ss").format("HH:mm (DD.MM.YYYY)");
        var date_input_dragged = moment(date_string_dragged, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY HH:mm");
        var bg_color_dragged = $(draggedRow).css('background-color');
        
        var game_id_target = targetRow.find('#id_starttime').eq(0).data('game_id');
        var game_counter_target = targetRow.find('#game_id_counter')[0].innerText;
        var date_label_target = moment(date_string_target, "YYYY-MM-DD HH:mm:ss").format("HH:mm (DD.MM.YYYY)");
        var date_input_target = moment(date_string_target, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY HH:mm");
        var bg_color_target = targetRow.css('background-color');

        targetRow.find('#id_starttime_label')[0].innerText = date_label_dragged;
        targetRow.find('#id_starttime')[0].value = date_input_dragged;
        targetRow.find('#game_id_counter')[0].innerText = game_counter_dragged;
        targetRow.css('background-color', bg_color_dragged);
        
        $(draggedRow).find('#id_starttime_label')[0].innerText = date_label_target;
        $(draggedRow).find('#id_starttime')[0].value = date_input_target;
        $(draggedRow).find('#game_id_counter')[0].innerText = game_counter_target;
        $(draggedRow).css('background-color', bg_color_target);
         
        let parent = targetRow.parent();
        let draggedIndex = $(draggedRow).index();
        let targetIndex = targetRow.index();
        var draggedSibbling = $(draggedRow)[0].nextSibling;
        if (draggedIndex < targetIndex) {
          targetRow[0].parentNode.insertBefore($(draggedRow)[0], targetRow[0].nextSibling);
          targetRow[0].parentNode.insertBefore(targetRow[0], draggedSibbling);
        } else {
          targetRow[0].parentNode.insertBefore($(draggedRow)[0], targetRow[0]);
          targetRow[0].parentNode.insertBefore(targetRow[0], draggedSibbling);
        }

        var gameJsonDragged = {'game': game_id_dragged,
         'datetime': moment($(draggedRow).find('#id_starttime')[0].value, "MM/DD/YYYY HH:mm").format("YYYY-MM-DD HH:mm:ss"),
        'game_counter': parseInt(game_counter_target)
        };
        postUpdateGameAfterDrag(game_id_dragged, gameJsonDragged);

        var gameJsonTarget = {'game': game_id_target,
         'datetime': moment(targetRow.find('#id_starttime')[0].value, "MM/DD/YYYY HH:mm").format("YYYY-MM-DD HH:mm:ss"),
        'game_counter': parseInt(game_counter_dragged)
        };
        postUpdateGameAfterDrag(game_id_target, gameJsonTarget);
      }
    }

    // Handle the end of a drag event
    function dragEnd(e) {
      console.log("drag end");
      $('#table-games').find('tr').each(function(index) {
        $(this).removeClass('tr-over');
      });
    }

    $('.game-list-datetime-label').on('dblclick', function () {
        $(this).attr('hidden', true);
        var close = $(this).parent().children('.game-list-datetime-input');
        $(close[0]).attr('hidden', false);
    });
    $(".game-list-datetime").on('keyup', function(e){ 
        var code = e.key; // recommended to use e.key, it's normalized across devices and languages
        if(code==="Enter") e.preventDefault();
        if(code===" " || code==="Enter" || code===","|| code===";"){
            var game_id = $(this).data('game_id');
            var date_string = moment($(this).val(), "MM/DD/YYYY HH:mm").format("YYYY-MM-DD HH:mm:ss");
            var data = postUpdateGameDateTime(game_id, date_string);
            $(this).closest('.game-list-datetime-input').first().attr('hidden', true);
            var close = $(this).closest('.game-list-datetime-td').first().children('.game-list-datetime-label');
            $(close[0]).attr('hidden', false);
            var table = $('#table-games').DataTable();
            var order = table.order([1,'asc']);
        } // missing closing if brace
    });

    $('.game-list-court-label').on('dblclick', function () {
        $(this).attr('hidden', true);
        var close = $(this).parent().children('.game-list-court-select');
        $(close[0]).attr('hidden', false);
    });
    $(".game-list-court-select").on('change', function(e){ 
      var game_id = $(this).data('game_id');
      var data = postUpdateGameCourt(game_id, $(e.target).val());
      $(this).closest('.game-list-court-select').first().attr('hidden', true);
      var close = $(this).closest('.game-list-court-td').first().children('.game-list-court-label');
      $(close[0]).attr('hidden', false);
      var table = $('#table-games').DataTable();
      var order = table.order([1,'asc']);

    });

    var asyncSuccessMessage2 = [
            "<div>",
            "</div>",
            "<script>",
            "<\/script>"
          ].join();

    function postUpdateGameAfterDrag(game_id, gameJsonData) {
      return $.ajax({
          type: 'POST',
          url: "ajax/update-game-after-drag/" + game_id + "/",
          data: gameJsonData,
          async: true,
          dataType: 'json',
          done: function (data) {
            console.debug('done');
            if (data) {
              console.debug(JSON.stringify(data));
              return data;
            }
          },
          success:function(response){
            console.log('success: ');
            },
          complete:function(){console.debug('complete');},
          error:function (xhr, textStatus, thrownError){console.debug('error');}
        });
    }

    function updateGameModalForm() {
      $(".update_game").each(function () {
        console.debug('#' + $(this).closest('table')[0].id);
          $(this).modalForm({
            modalID: "#game-modal",
            formURL: $(this).data("form-url"),
            asyncUpdate: false,
            asyncSettings: {
              closeOnSubmit: true,
              successMessage: asyncSuccessMessage2,
              dataUrl: $(this).data("list-url"),
              dataElementId: '#' + $(this).closest('table')[0].id,
              dataKey: "table",
              addModalFormFunction: reinstantiateModalForms
            }
        });
      });
    }
    updateGameModalForm();
        
    function updateGameResultModalForm() {
            $(".update-game-result").each(function () {
              console.debug('#' + $(this).closest('table')[0].id);
                $(this).modalForm({
                  modalID: "#game-modal",
                  formURL: $(this).data("form-url"),
                 asyncUpdate: true,
                 asyncSettings: {
                    closeOnSubmit: true,
                    successMessage: asyncSuccessMessage2,
                    dataUrl: $(this).data("list-url"),
                    dataElementId: '#' + $(this).closest('table')[0].id,
                    dataKey: "table",
                    addModalFormFunction: reinstantiateModalForms
                  }
              });
            });
          }
          updateGameResultModalForm();
    function reinstantiateModalForms() {
            updateGameResultModalForm();
            updateGameModalForm();
          }
    function getUpdateGameDateTime(game_id) {
        return $.ajax({
            type: 'GET',
            url: "ajax/update-game-date/" + game_id + "/",
            async: true,
            dataType: 'json',
            done: function (data) {
              if (data) {
                console.debug(JSON.stringify(data));
                return data;
              }
            }
          });
      }
      function postUpdateGameDateTime(game_id, new_datetime) {
        return $.ajax({
            type: 'POST',
            url: "ajax/update-game-date/" + game_id + "/",
            data: {'game': game_id, 'datetime': new_datetime},
            async: true,
            dataType: 'json',
            done: function (data) {
              console.debug('done');
              if (data) {
                console.debug(JSON.stringify(data));
                return data;
              }
            },
            success:function(response){
              console.debug('success: ');
              var date_label = moment(response.new_datetime, "YYYY-MM-DD HH:mm:ss").format("HH:mm (DD.MM.YYYY)");
              var date_input = moment(response.new_datetime, "YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY HH:mm");

              var game_td = $('#game-list-td-id-' + response.game)
              $(game_td).children('.game-list-datetime-label').first().text(date_label);
              $(game_td).children('.game-list-datetime-input').first().children().each(function(i, input){ $(input).val(date_input);});
              },
            complete:function(){console.debug('complete');},
            error:function (xhr, textStatus, thrownError){console.debug('error');}
          });
      }

      function postUpdateGameCourt(game_id, new_court_id) {
        return $.ajax({
            type: 'POST',
            url: "ajax/update-game-court/" + game_id + "/",
            data: {'game': game_id, 'new_court': new_court_id},
            async: true,
            dataType: 'json',
            done: function (data) {
              console.debug('done');
              if (data) {
                console.debug(JSON.stringify(data));
                return data;
              }
            },
            success:function(response){
              console.debug('success: ');

              var game_td = $('#game-list-td-court-' + response.game)
              $(game_td).children('.game-list-court-label').first().text(response.court);
              },
            complete:function(){console.debug('complete');},
            error:function (xhr, textStatus, thrownError){console.debug('error');}
          });
      }

    function add_filter(filter) {
        var filter_obj = {'col': 'Team A', 'filter': filter }
        $('#games-filter').val(JSON.stringify(filter_obj));$('#games-filter').keyup();
      }
    function add_filter_tevent() {
      var opt_val = $('#filter-tevent').children("option:selected").val();
      if(opt_val == -1)
      {
        opt_val = "";
        $("#filter-tevent > option").each(function() {
            if((this.value == -1) || (this.value == '') )return;

            opt_val = opt_val + "ยง" + this.value;
        });
        opt_val = opt_val.substring(1, opt_val.length);
      }
      var filter_obj = {'col': 'tournament_event', 'filter': opt_val }
      $('#games-filter').val(JSON.stringify(filter_obj));$('#games-filter').keyup();
    }
    function add_filter_tstate() {
      var opt_val = $('#filter-tstate').children("option:selected").val();
      if(opt_val == -1)
      {
        opt_val = "";
        $("#filter-tstate > option").each(function() {
            if((this.value == -1) || (this.value == '') )return;

            opt_val = opt_val + "ยง" + this.value;
        });
        opt_val = opt_val.substring(1, opt_val.length);
      }
      var filter_obj = {'col': 'tournament_state', 'filter': opt_val }
      $('#games-filter').val(JSON.stringify(filter_obj));$('#games-filter').keyup();
    }
    function add_filter_court() {
      var opt_val = $('#filter-court').children("option:selected").val();
      if(opt_val == -1)
      {
        opt_val = "";
        $("#filter-court > option").each(function() {
            if((this.value == -1) || (this.value == '') )return;

            opt_val = opt_val + "ยง" + this.value;
        });
        opt_val = opt_val.substring(1, opt_val.length);
      }
      var filter_obj = {'col': 'court', 'filter': opt_val }
      $('#games-filter').val(JSON.stringify(filter_obj));$('#games-filter').keyup();
    }
    function add_filter_gamestate() {
      var opt_val = $('#filter-gamestate').children("option:selected").val();
      if(opt_val == -1)
      {
        opt_val = "";
        $("#filter-gamestate > option").each(function() {
            if((this.value == -1) || (this.value == '') )return;

            opt_val = opt_val + "ยง" + this.value;
        });
        opt_val = opt_val.substring(1, opt_val.length);
      }
      var filter_obj = {'col': 'gamestate', 'filter': opt_val }
      $('#games-filter').val(JSON.stringify(filter_obj));$('#games-filter').keyup();
    }

    function add_filter_keyword() {
      var opt_val = $('#filter-keyword').val();

      var filter_obj = {'col': '__all__', 'filter': opt_val }
      $('#games-filter').val(JSON.stringify(filter_obj));$('#games-filter').keyup();
    }
  </script>

{% endblock javascripts %}